(()=>{"use strict";var e,t,o,n,r,i,u,d,c,a,s,l,p,m,f,v,w,y,h,_,g,S,E,q,L,k,C,b,x,M,D,A,P,F,T,R;e=["gif","jpg","jpeg","png"],t=document.querySelector(".ad-form-header__input"),o=document.querySelector(".ad-form-header__preview img"),n=document.querySelector(".ad-form__input"),r=document.querySelector(".ad-form__photo"),i=o.src,u=function(){r.querySelector("img")&&r.querySelector("img").remove()},d=function(i){var d=i.files[0],c=d.name.toLowerCase();if(e.some((function(e){return c.endsWith(e)}))){var a=new FileReader;i===t?(a.addEventListener("load",(function(){o.src=a.result})),a.readAsDataURL(d)):i===n&&(a.addEventListener("load",(function(){var e;u(),(e=document.createElement("img")).src=a.result,e.width="70",e.height="70",r.appendChild(e)})),a.readAsDataURL(d))}},c=function(){d(t)},a=function(){d(n)},window.previewImage={getFileChoice:function(){t.addEventListener("change",c),n.addEventListener("change",a)},removeFileChoice:function(){t.removeEventListener("change",c),o.src=i,n.removeEventListener("change",a),u()}},window.utils={ifEscEvent:function(e){return"Escape"===e.key}},window.debounce=function(e){var t=null;return function(...o){t&&window.clearTimeout(t),t=window.setTimeout((function(){e(...o)}),300)}},s=document.querySelector("#error").content.querySelector(".error").cloneNode(!0),l=function(e){(1===e.which||window.utils.ifEscEvent(e))&&(document.removeEventListener("keydown",l),document.removeEventListener("mousedown",l),document.querySelector(".error").remove())},window.loadMessage={getErrorPopup:function(e){s.querySelector(".error__message").textContent=e,document.querySelector("main").appendChild(s),document.addEventListener("keydown",l),document.addEventListener("mousedown",l)}},window.backend={load:function(e,t){var o=new XMLHttpRequest;o.responseType="json",o.addEventListener("load",(function(){200===o.status?e(o.response):t("Статус ответа "+o.status+" "+o.statusText)})),o.addEventListener("error",(function(){t("Произошла ошибка соединения")})),o.addEventListener("timeout",(function(){t("Критичесское время выполнения запроса сервера "+o.timeout+"мс пожалуйста, повторите операцию.")})),o.timeout=1e4,o.open("GET","https://21.javascript.pages.academy/keksobooking/data"),o.send()}},window.upload={submitData:function(e,t,o){var n=new XMLHttpRequest;n.responseType="json",n.addEventListener("load",(function(){200===n.status?t(n.response):o("Статус ответа "+n.status+" "+n.statusText)})),n.addEventListener("error",(function(){o("Произошла ошибка отправки")})),n.addEventListener("timeout",(function(){o("Критичесское время выполнения отправки на сервер "+n.timeout+"мс пожалуйста, повторите операцию.")})),n.timeout=1e4,n.open("POST","https://21.javascript.pages.academy/keksobooking"),n.send(e)}},p=document.querySelector("#success").content.querySelector(".success").cloneNode(!0),m=function(e){(1===e.which||window.utils.ifEscEvent(e))&&(document.removeEventListener("keydown",m),document.removeEventListener("mousedown",m),document.querySelector(".success").remove())},f=document.querySelector("#error").content.querySelector(".error").cloneNode(!0),v=function(e){(1===e.which||window.utils.ifEscEvent(e))&&(document.removeEventListener("keydown",v),document.removeEventListener("mousedown",v),document.querySelector(".error").remove())},window.sendMessage={getSuccessPopup:function(){document.querySelector("main").appendChild(p),document.addEventListener("keydown",m),document.addEventListener("mousedown",m)},getErrorPopup:function(e){f.querySelector(".error__message").textContent="Ошибка загрузки объявления "+e,document.querySelector("main").appendChild(f),document.addEventListener("keydown",v),document.addEventListener("mousedown",v)}},(()=>{var e=document.querySelector("#room_number"),t=document.querySelector("#capacity"),o=document.querySelector("#price"),n=document.querySelector("#type"),r={bungalo:"0",flat:"1000",house:"5000",palace:"10000"},i=function(){t.options[t.selectedIndex].value!==e.options[e.selectedIndex].value&&(t.options[t.selectedIndex].value>e.options[e.selectedIndex].value||"0"===t.options[t.selectedIndex].value&&e.options[e.selectedIndex].value>t.options[t.selectedIndex].value)?(e.setCustomValidity("Некорректное значение"),t.style.backgroundColor="pink",e.style.backgroundColor="pink"):(e.setCustomValidity(""),t.style.backgroundColor="",e.style.backgroundColor="")},u=function(){o.placeholder=o.min=r[document.querySelector("#type").value]},d=document.querySelector("#timein");d.onchange=function(){document.querySelector("#timeout").value=d.value};var c=document.querySelector("#timeout");c.onchange=function(){document.querySelector("#timein").value=c.value};var a=function(){s.setCustomValidity(""),s.style.backgroundColor="",s.style.backgroundColor=""},s=document.querySelector("#title"),l=function(){s.value.length<s.min||s.value.length>s.max?(s.setCustomValidity("Количество вводимых символов составляет от "+s.min+" до "+s.max),s.style.backgroundColor="pink",s.style.backgroundColor="pink"):a()};window.validation={onRoomNumbersCheck:i,onRoomPriceCheck:u,addFieldCheck:function(){e.addEventListener("change",i),t.addEventListener("change",i),n.addEventListener("change",u),s.addEventListener("input",l)},removeFieldCheck:function(){e.removeEventListener("change",i),t.removeEventListener("change",i),n.removeEventListener("change",u),s.removeEventListener("input",l)},removeTitleCheck:a}})(),(R=document.querySelector(".map")).classList.add("map--faded"),window.map={section:R,removeAttributeDisabled:function(e){Array.from(e).forEach((function(e){e.removeAttribute("disabled","true")}))},setAttributeDisabled:function(e){Array.from(e).forEach((function(e){e.setAttribute("disabled","true")}))}},w=document.querySelector(".map__pin--main"),y=document.querySelector("#address"),h={x:w.style.left,y:w.style.top},_=function(){return y.value=Math.round(w.offsetLeft+w.offsetWidth/2)+", "+Math.round(w.offsetTop+w.offsetHeight/2),y.value},window.address={getStartCoords:_,getMoveCoords:function(){y.value=Math.round(w.offsetLeft-w.offsetWidth/2)+", "+Math.round(w.offsetTop-(w.offsetHeight/2+22))},returnFirstCoordsMapPinMain:function(){w.style.left=h.x,w.style.top=h.y,_()}},(()=>{var e=document.querySelector(".ad-form");window.address.getStartCoords();var t=document.querySelector("#pin").content.querySelector(".map__pin"),o=document.createDocumentFragment(),n=document.querySelector(".map__pins"),r=function(){document.querySelectorAll(".map__pin:not(.map__pin--main)").forEach((function(e){e.remove()}))};window.pin={activateMainActions:function(){e.classList.remove("ad-form--disabled"),window.map.removeAttributeDisabled(window.form.liveElements),window.map.removeAttributeDisabled(window.form.liveMapFilterElements),window.map.section.classList.remove("map--faded"),window.backend.load((function(e){e.forEach((function(e,t){e.author.id=t+1})),window.pin.renderCards(window.filter.getVerification(e))}),window.loadMessage.getErrorPopup),window.address.getMoveCoords(),window.validation.onRoomNumbersCheck(),window.validation.onRoomPriceCheck(),window.validation.addFieldCheck(),window.previewImage.getFileChoice(),window.form.getSubmitListener(),window.form.getListenerResetValue()},renderCards:function(e){r(),e.forEach((function(e,n){var r,i,u;o.appendChild((r=e,(u=(i=t.cloneNode(!0)).querySelector("img")).src=r.author.avatar,u.alt=r.offer.title,u.id=r.author.id,i.style.left=r.location.x-25+"px",i.style.top=r.location.y-70+"px",i))})),n.appendChild(o),window.card.addOpeningProperty(e)},removeOlds:r}})(),g=document.querySelector(".map__filters"),S=document.querySelector("#housing-type"),E=document.querySelector("#housing-price"),q=document.querySelector("#housing-rooms"),L=document.querySelector("#housing-guests"),k=document.querySelector("#housing-features"),C=[],b=function(e){return C=e,e.filter((function(e){var t=!!e.offer,o="any"===S.value||e.offer.type===S.value,n="any"===q.value||e.offer.rooms===+q.value,r="any"===L.value||e.offer.guests===+L.value,i=function(e){switch(E.value){case"any":return!0;case"low":return e.offer.price<1e4;case"middle":return e.offer.price>1e4&&e.offer.price<5e4;case"high":return e.offer.price>5e4;default:return e===E.value}}(e),u=Array.from(k.querySelectorAll("input:checked")).map((function(e){return e.value})).every((function(t){return e.offer.features.includes(t)}));return t&&o&&n&&r&&i&&u})).slice(0,5)},x=window.debounce((function(){window.card.popupDelete(),window.pin.renderCards(b(C))})),g.addEventListener("change",x),window.filter={getVerification:b},M={wifi:"popup__feature--wifi",dishwasher:"popup__feature--dishwasher",parking:"popup__feature--parking",washer:"popup__feature--washer",elevator:"popup__feature--elevator",conditioner:"popup__feature--conditioner"},D={flat:"Квартира",bungalo:"Бунгало",house:"Дом",palace:"Дворец"},A=function(){null!==document.querySelector(".popup")&&(document.removeEventListener("keydown",P),document.querySelector(".popup__close").removeEventListener("mousedown",F),document.querySelector(".popup").remove())},P=function(e){window.utils.ifEscEvent(e)&&(A(),T())},F=function(e){!function(e){1!==e.which&&"Enter"!==e.key||(document.querySelector(".popup__close").removeEventListener("mousedown",F),document.querySelector(".popup__close").removeEventListener("keydown",F),document.removeEventListener("keydown",P),document.querySelector(".popup").remove(),T())}(e)},T=function(){var e=document.querySelector(".map__pin--active");null!==e&&e.classList.remove("map__pin--active")},window.card={addOpeningProperty:function(e){var t=function(t){1!==t.which&&"Enter"!==t.key||function(t){A(),T(),t.currentTarget.classList.add("map__pin--active");var o=document.querySelector("#card").content.querySelector(".popup"),n=o.cloneNode(!0),r=e.find((function(e){if("button"===t.target.type){var o=t.target.querySelector("img");return e.author.id.toString()===o.id}return e.author.id.toString()===t.target.id}));r.offer.title&&(n.querySelector(".popup__title").textContent=r.offer.title),r.offer.address&&(n.querySelector(".popup__text--address").textContent=r.offer.address),r.offer.price&&(n.querySelector(".popup__text--price").textContent=r.offer.price+" ₽/ночь"),r.offer.rooms&&r.offer.guests&&(n.querySelector(".popup__text--capacity").textContent=r.offer.rooms+" комнаты для "+r.offer.guests+" гостей."),r.offer.checkin&&r.offer.checkout&&(n.querySelector(".popup__text--time").textContent="Заезд после "+r.offer.checkin+", выезд до "+r.offer.checkout),0!==r.offer.features.length?(r.offer.features.forEach((function(e){var t=o.querySelector(".popup__feature").cloneNode(!0);t.classList.add(M[e]),n.querySelector(".popup__features").appendChild(t)})),n.querySelectorAll(".popup__feature")[0].remove()):n.querySelector(".popup__features").remove(),r.offer.description&&(n.querySelector(".popup__description").textContent=r.offer.description),r.author.avatar&&(n.querySelector(".popup__avatar").src=r.author.avatar),r.offer.type&&(n.querySelector(".popup__type").textContent=D[r.offer.type]),0!==r.offer.photos.length&&(r.offer.photos.forEach((function(e){o.querySelector(".popup__photo").src=e,n.querySelector(".popup__photos").appendChild(o.querySelector(".popup__photo").cloneNode(!0))})),n.querySelectorAll(".popup__photo")[0].remove()),document.querySelector(".map__pins").after(n),document.querySelector(".popup__close").addEventListener("mousedown",F),document.querySelector(".popup__close").addEventListener("keydown",F),document.addEventListener("keydown",P)}(t)};document.querySelectorAll(".map__pin:not(.map__pin--main)").forEach((function(e){e.addEventListener("mousedown",t),e.addEventListener("keydown",t)}))},popupDelete:A},(()=>{var e=document.querySelector(".map__pin--main"),t=!0,o=e.offsetWidth/2,n=window.map.section.offsetWidth-window.map.section.offsetWidth-o,r=window.map.section.offsetWidth-o,i=function(){t&&window.pin.activateMainActions(),t=!1},u=function(t){if("Enter"===t.key&&i(),1===t.which){t.preventDefault(),i();var o={x:t.clientX,y:t.clientY},u=function(t){t.preventDefault();var i=o.x-t.clientX,u=o.y-t.clientY;o={x:t.clientX,y:t.clientY};var d=e.offsetTop-u,c=e.offsetLeft-i;d=d<130?130:d>630?630:e.offsetTop-u,c=c<n?n:c>r?r:e.offsetLeft-i,e.style.top=d+"px",e.style.left=c+"px",window.address.getMoveCoords()},d=function(e){e.preventDefault(),document.removeEventListener("mousemove",u),document.removeEventListener("mouseup",d)};document.addEventListener("mousemove",u),document.addEventListener("mouseup",d)}},d=function(){e.addEventListener("mousedown",u),e.addEventListener("keydown",u)};d(),window.move={activateMainPin:d,activateMainPinRestart:function(){t=!0}}})(),(()=>{var e=document.querySelector(".ad-form"),t=document.querySelector(".ad-form").children,o=document.querySelector(".map__filters").children;e.classList.add("ad-form--disabled");var n=function(){window.map.setAttributeDisabled(t),window.map.setAttributeDisabled(o)};n();var r=function(){window.map.section.classList.add("map--faded"),e.classList.add("ad-form--disabled"),n(),s(),d(),window.previewImage.removeFileChoice(),document.querySelector(".map__filters").reset(),e.reset(),window.validation.removeFieldCheck(),window.pin.removeOlds(),window.card.popupDelete(),window.address.returnFirstCoordsMapPinMain(),window.move.activateMainPinRestart(),window.move.activateMainPin(),window.validation.removeTitleCheck(),window.validation.onRoomNumbersCheck()},i=function(e){e.preventDefault(),r()},u=e.querySelector(".ad-form__reset"),d=function(){u.removeEventListener("click",i)},c=function(){r(),window.sendMessage.getSuccessPopup()},a=function(t){try{window.upload.submitData(new FormData(e),c,window.sendMessage.getErrorPopup),t.preventDefault()}catch(e){t.preventDefault(),window.sendMessage.getErrorPopup(e)}},s=function(){e.removeEventListener("submit",a)};window.form={liveElements:t,liveMapFilterElements:o,getSubmitListener:function(){e.addEventListener("submit",a)},getListenerResetValue:function(){u.addEventListener("click",i)}}})()})();